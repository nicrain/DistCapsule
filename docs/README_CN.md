# 智能胶囊分配器 (Smart Capsule Dispenser)

[![Français](https://img.shields.io/badge/Language-Français-blue.svg)](../README.md)

**平台:** Raspberry Pi 5 (Bookworm OS) | **状态:** 稳定 (V1.1) | **最后更新:** 2026-01-18

这是一个安全的、支持生物识别的胶囊分配系统。它将标准的胶囊展示架转变为个性化的“信箱”系统，每个用户通过指纹或人脸认证拥有对特定存储通道的专属访问权。系统支持多用户录入、权限分级（管理员/普通用户）以及物理通道的动态分配。

---

## ✨ 主要功能

*   **全自动 IoT 生态**: 集成原生 Android App、FastAPI 后端以及树莓派硬件控制，实现端到端的无缝连接。
*   **多线程架构**: 独立的人脸识别、UI 刷新和网络指令处理线程，确保在高负载下依然响应迅速。
*   **智能电源管理**: 30秒无操作自动休眠，物理按钮支持即时唤醒。
*   **极致 UX 体验 (V1.1)**: 全新 Vivid 配色方案，支持自动登录、一键注册、自定义 App 图标以及可视化的通道分配界面。

---

## 🛠 硬件架构

*   **控制器**: Raspberry Pi 5。
*   **执行器**: 5x SG90 微型舵机 (9g)。
*   **传感器**: DY-50 光学指纹模块 (UART) + Camera Module 3。
*   **人机交互**: 1.3" IPS LCD + **智能唤醒按钮**。

---

## 🚀 安装与设置

### 5. 网络与 API 配置 (全自动)
使用一键安装脚本，自动配置 Wi-Fi 热点、API 服务器以及硬件主程序作为系统服务运行：

```bash
cd tools
sudo ./install_service.sh
```
*   **Wi-Fi SSID**: `DistCapsule_Box` (192.168.4.1)
*   **API 端口**: 8000
*   **自启**: 树莓派开机后所有服务将自动启动。

---

## 📱 Android 移动应用 (V1.1)

配套 App（位于 `android/` 目录）已针对 Pi 5 深度优化：

*   **Vivid UI**: 采用现代色彩体系（绿宝石、向日葵、珊瑚红），确保高对比度与专业感。
*   **自动登录**: 注册后下次打开 App 即刻直达控制台。
*   **简化 IP 输入**: 只需输入 IP，App 自动补全协议与端口。
*   **可视化选座**: 按钮式通道分配，支持动画反馈与冲突检测。
*   **实时同步**: 录入指纹或人脸时，手机端与机器屏幕同步状态。

---

## 📖 使用指南

### 1. 快速注册
打开 App，输入姓名点击“创建并连接”。系统会自动分配第一个空闲通道。

### 2. 提升管理员权限
```bash
sqlite3 capsule_dispenser.db "UPDATE Users SET auth_level=1 WHERE user_id=1;"
```

### 3. 生物识别录入
在 App 中点击“添加面部”或“添加指纹”，树莓派屏幕会自动点亮并引导您完成录入。

---

## 📂 项目结构

| 文件/目录 | 描述 |
| :--- | :--- |
| `main.py` | 硬件主逻辑。 |
| `api/server.py` | FastAPI 后端服务。 |
| `android/` | Android Studio 源代码。 |
| `hardware/` | 硬件驱动与录入逻辑。 |
| `tools/` | 安装与维护工具脚本。 |

---

## 🔮 未来计划

*   **远程推送**: 指令执行成功后的手机通知提醒。
*   **3D 外壳**: 正在完善针对 Pi 5 的全包裹式保护壳设计。

---

## 📜 历史与决策

*   **2026-01 (V1.1)**: **体验革命**。重构 Android UI，增加自动登录，修复硬件死锁漏洞。
*   **2026-01 (V1.0)**: **IoT 闭环**。首次打通 App -> API -> 数据库 -> 硬件链路。
*   **2025-12 (S5)**: **内核重构**。迁移至 `lgpio` 并实现全异步架构。

---

*   **注**: 项目已移除 MQTT 支持与库存追踪功能，以确保生物识别访问的核心稳定性。

## License
MIT License