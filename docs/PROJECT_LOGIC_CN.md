# ☕ DistCapsule 咖啡胶囊分配器 - 项目核心逻辑指南 (中文版)

本文档旨在总结 `DistCapsule` 项目的核心设计逻辑，方便开发者快速理解系统的运作方式。

---

## 1. 🏗️ AAA 项目架构 (Android, Arduino/Pi, Agent)

该项目遵循经典的 IoT 三层架构：

*   **Android (前端交互层)**:
    *   作为用户的无线操作界面。
    *   功能：用户登录（Token 认证）、查看咖啡轨道状态、点击“取咖啡”、管理用户（录入/删除）。
*   **Arduino/Pi (硬件执行层)**:
    *   负责物理动作：转动舵机（5个轨道）、驱动 LCD 屏幕、读取指纹和摄像头数据。
    *   使用 `lgpio` 库解决 Pi 5 的硬件冲突问题。
*   **Agent Artificiel (智能决策层)**:
    *   运行在树莓派上的核心 Python 逻辑。
    *   负责：人脸识别算法、多线程调度（AI 与 UI 分离）、指令队列管理、状态机切换。

---

## 2. 📱 移动端 App 逻辑

### 角色权限
*   **管理员 (Admin)**: 拥有最高权限。可以查看所有用户、给用户分配咖啡轨道、远程触发机器开始录入指纹/人脸、强制开启任何轨道。
*   **普通用户 (User)**: 只能操作分配给自己的那一个轨道。可以查看谁占用了哪些轨道，也可以注销自己的账号。

### 登录与绑定 (Token 机制)
*   系统不使用传统的“账号/密码”。
*   **首次连接**: 手机连接机器热点，在列表中选择自己的名字进行绑定。App 生成唯一的 **Token (UUID)** 发送给服务器。
*   **自动登录**: 以后打开 App，自动发送该 Token 进行身份验证。

---

## 3. 🛡️ 生物识别与安全性

### 三种并列的验证方式
1.  **指纹**: 走到机器前，按压指纹。
2.  **人脸**: 走到机器前，注视摄像头。
3.  **App**: 通过手机 App 远程（局域网）点击按钮。

### 技术适配
*   **摄像头旋转**: 物理安装将摄像头旋转了 90°，软件层使用 OpenCV 进行 **逆时针 90° (Counter-Clockwise)** 旋转修正。
*   **识别阈值**: 经过实测，将人脸识别的特征差异阈值设为 **0.68**，兼顾了安全性与识别率。

---

## 4. ⚙️ 跨进程通信 (API -> 硬件)

为了让 Web API (FastAPI) 能够控制硬件 (`main.py`)，我们实现了 **指令队列 (Pending_Commands)** 机制：

1.  App 发送请求给 API。
2.  API 往数据库 `Pending_Commands` 表中插入任务（如 `UNLOCK` 或 `ENROLL_FACE`）。
3.  硬件主程序每秒轮询一次该表，发现任务后立即执行：
    *   **录入模式**: 机器会自动唤醒，切换到录入界面，引导用户。
    *   **录入后 UX**: 录入成功后会停顿 3 秒，防止用户还没离开就立刻触发自动识别开锁。

---

## 5. 🛠 硬件连线参考 (核心)

*   **屏幕 (ST7789)**: 供电 3.3V，GND 接物理 **Pin 20**。
*   **按钮 (Wake-Up)**: 信号接 **GPIO 26 (Pin 37)**，必须接 3.3V 严禁 5V。
*   **指纹 (DY-50)**: 供电 3.3V（已焊接），串口通讯使用 `/dev/ttyAMA0`。
*   **舵机**: 5 个舵机依次接 **GPIO 18, 6, 12, 13, 19**。**必须使用外部 5V 供电。**

---
*祝答辩顺利！如有变动，请及时同步文档。*
